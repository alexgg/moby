---
name: prepare draft release
# https://github.com/product-os/flowzone/tree/master/.github/actions
inputs:
  json:
    description: "JSON stringified object containing all the inputs from the calling workflow"
    required: true
  secrets:
    description: "JSON stringified object containing all the secrets from the calling workflow"
    required: true

  # --- custom environment
  VERBOSE:
    type: string
    default: "true"

runs:
  # https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
  using: "composite"
  steps:
    - name: Delete previous draft release
      shell: bash
      run: |
        set -ea

        [[ '${{ inputs.VERBOSE }}' =~ on|On|Yes|yes|true|True ]] && set -x

        gh release delete --yes '${{ github.event.pull_request.head.ref }}' || true

      env:
        GITHUB_TOKEN: ${{ fromJSON(inputs.secrets).FLOWZONE_TOKEN }}

    # https://github.com/softprops/action-gh-release#-customizing
    - name: Create release placeholder
      uses: softprops/action-gh-release@v1
      with:
        # use PR branch name for draft releases
        name: ${{ github.event.pull_request.head.ref }}
        tag_name: ${{ github.event.pull_request.head.ref }}
        draft: true
        prerelease: true
        token: ${{ fromJSON(inputs.secrets).FLOWZONE_TOKEN }}
